/*
   Stomp Over WebSocket http://www.jmesnil.net/stomp-websocket/doc/ | Apache License V2.0

   Copyright (C) 2010-2013 [Jeff Mesnil](http://jmesnil.net/)
   Copyright (C) 2012 [FuseSource, Inc.](http://fusesource.com)
 */

/*!
 * EventEmitter v4.2.7 - git.io/ee
 * Oliver Caldwell
 * MIT license
 * @preserve
 */

(function(){var e,t,n,r,i={}.hasOwnProperty,s=[].slice;e={LF:"\n",NULL:"\0"},n=function(){function n(e,t,n){this.command=e,this.headers=t!=null?t:{},this.body=n!=null?n:""}var t;return n.prototype.toString=function(){var t,r,s,o,u;t=[this.command],s=this.headers["content-length"]===!1?!0:!1,s&&delete this.headers["content-length"],u=this.headers;for(r in u){if(!i.call(u,r))continue;o=u[r],t.push(""+r+":"+o)}return this.body&&!s&&t.push("content-length:"+n.sizeOfUTF8(this.body)),t.push(e.LF+this.body),t.join(e.LF)},n.sizeOfUTF8=function(e){return e?encodeURI(e).match(/%..|./g).length:0},t=function(t){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;o=t.search(RegExp(""+e.LF+e.LF)),u=t.substring(0,o).split(e.LF),s=u.shift(),a={},d=function(e){return e.replace(/^\s+|\s+$/g,"")},y=u.reverse();for(v=0,g=y.length;v<g;v++)h=y[v],l=h.indexOf(":"),a[d(h.substring(0,l))]=d(h.substring(l+1));r="",p=o+2;if(a["content-length"])c=parseInt(a["content-length"]),r=(""+t).substring(p,p+c);else{i=null;for(f=m=p,b=t.length;p<=b?m<b:m>b;f=p<=b?++m:--m){i=t.charAt(f);if(i===e.NULL)break;r+=i}}return new n(s,a,r)},n.unmarshall=function(n){var r,i,s,o;return i=n.split(RegExp(""+e.NULL+e.LF+"*")),o={frames:[],partial:""},o.frames=function(){var e,n,s,o;s=i.slice(0,-1),o=[];for(e=0,n=s.length;e<n;e++)r=s[e],o.push(t(r));return o}(),s=i.slice(-1)[0],s===e.LF||s.search(RegExp(""+e.NULL+e.LF+"*$"))!==-1?o.frames.push(t(s)):o.partial=s,o},n.marshall=function(t,r,i){var s;return s=new n(t,r,i),s.toString()+e.NULL},n}(),t=function(){function i(e){this.ws=e,this.ws.binaryType="arraybuffer",this.counter=0,this.connected=!1,this.heartbeat={outgoing:1e4,incoming:1e4},this.maxWebSocketFrameSize=16384,this.subscriptions={},this.partialData=""}var t;return i.prototype.debug=function(e){return null},t=function(){return Date.now?Date.now():(new Date).valueOf},i.prototype._transmit=function(e,t,r){var i;i=n.marshall(e,t,r),typeof this.debug=="function"&&this.debug(">>> "+i);for(;;){if(!(i.length>this.maxWebSocketFrameSize))return this.ws.send(i);this.ws.send(i.substring(0,this.maxWebSocketFrameSize)),i=i.substring(this.maxWebSocketFrameSize),typeof this.debug=="function"&&this.debug("remaining = "+i.length)}},i.prototype._parseConnect=function(){var e,t,n,r;e=1<=arguments.length?s.call(arguments,0):[],r={};switch(e.length){case 2:r=e[0],t=e[1];break;case 3:e[1]instanceof Function?(r=e[0],t=e[1],n=e[2]):(r.login=e[0],r.passcode=e[1],t=e[2]);break;case 4:r.login=e[0],r.passcode=e[1],t=e[2],n=e[3];break;default:r.login=e[0],r.passcode=e[1],t=e[2],n=e[3],r.host=e[4]}return[r,t,n]},i.prototype.connect=function(){var i,o,u,a;return i=1<=arguments.length?s.call(arguments,0):[],a=this._parseConnect.apply(this,i),u=a[0],this.connectCallback=a[1],o=a[2],typeof this.debug=="function"&&this.debug("Opening Web Socket..."),this.ws.onmessage=function(r){return function(i){var s,u,a,f,l,c,h,p,d,v,m,g,y;f=typeof ArrayBuffer!="undefined"&&i.data instanceof ArrayBuffer?(s=new Uint8Array(i.data),typeof r.debug=="function"?r.debug("--- got data length: "+s.length):void 0,function(){var e,t,n;n=[];for(e=0,t=s.length;e<t;e++)u=s[e],n.push(String.fromCharCode(u));return n}().join("")):i.data,r.serverActivity=t();if(f===e.LF){typeof r.debug=="function"&&r.debug("<<< PONG");return}typeof r.debug=="function"&&r.debug("<<< "+f),d=n.unmarshall(r.partialData+f),r.partialData=d.partial,g=d.frames,y=[];for(v=0,m=g.length;v<m;v++){l=g[v];switch(l.command){case"CONNECTED":typeof r.debug=="function"&&r.debug("connected to server "+l.headers.server),r.connected=!0,y.push(typeof r.connectCallback=="function"?r.connectCallback(l):void 0);break;case"MESSAGE":p=l.headers.subscription,h=r.subscriptions[p]||r.onreceive,h?(a=r,c=l.headers["message-id"],l.ack=function(e){return e==null&&(e={}),a.ack(c,p,e)},l.nack=function(e){return e==null&&(e={}),a.nack(c,p,e)},y.push(h(l))):y.push(typeof r.debug=="function"?r.debug("Unhandled received MESSAGE: "+l):void 0);break;case"RECEIPT":y.push(typeof r.onreceipt=="function"?r.onreceipt(l):void 0);break;case"ERROR":y.push(typeof o=="function"?o(l):void 0);break;default:y.push(typeof r.debug=="function"?r.debug("Unhandled frame: "+l):void 0)}}return y}}(this),this.ws.onclose=function(e){return function(){var t;return t="Whoops! Lost connection to "+e.ws.url,typeof e.debug=="function"&&e.debug(t),e._cleanUp(),typeof o=="function"?o(t):void 0}}(this),this.ws.onopen=function(e){return function(){return typeof e.debug=="function"&&e.debug("Web Socket Opened..."),u["accept-version"]=r.VERSIONS.supportedVersions(),e._transmit("CONNECT",u)}}(this)},i.prototype.disconnect=function(e,t){return t==null&&(t={}),this._transmit("DISCONNECT",t),this.ws.onclose=null,this.ws.close(),this._cleanUp(),typeof e=="function"?e():void 0},i.prototype._cleanUp=function(){this.connected=!1,this.pinger&&r.clearInterval(this.pinger);if(this.ponger)return r.clearInterval(this.ponger)},i.prototype.send=function(e,t,n){return t==null&&(t={}),n==null&&(n=""),t.destination=e,this._transmit("SEND",t,n)},i.prototype.subscribe=function(e,t,n){var r;return n==null&&(n={}),n.id||(n.id="sub-"+this.counter++),n.destination=e,this.subscriptions[n.id]=t,this._transmit("SUBSCRIBE",n),r=this,{id:n.id,unsubscribe:function(){return r.unsubscribe(n.id)}}},i.prototype.unsubscribe=function(e){return delete this.subscriptions[e],this._transmit("UNSUBSCRIBE",{id:e})},i.prototype.begin=function(e){var t,n;return n=e||"tx-"+this.counter++,this._transmit("BEGIN",{transaction:n}),t=this,{id:n,commit:function(){return t.commit(n)},abort:function(){return t.abort(n)}}},i.prototype.commit=function(e){return this._transmit("COMMIT",{transaction:e})},i.prototype.abort=function(e){return this._transmit("ABORT",{transaction:e})},i.prototype.ack=function(e,t,n){return n==null&&(n={}),n["message-id"]=e,n.subscription=t,this._transmit("ACK",n)},i.prototype.nack=function(e,t,n){return n==null&&(n={}),n["message-id"]=e,n.subscription=t,this._transmit("NACK",n)},i}(),r={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.1,1.0"}},client:function(e,n){var i,s;return n==null&&(n=["v10.stomp","v11.stomp"]),i=r.WebSocketClass||WebSocket,s=new i(e,n),new t(s)},over:function(e){return new t(e)},Frame:n},typeof exports!="undefined"&&exports!==null&&(exports.Stomp=r),typeof window!="undefined"&&window!==null?(r.setInterval=function(e,t){return window.setInterval(t,e)},r.clearInterval=function(e){return window.clearInterval(e)},window.Stomp=r):exports||(self.Stomp=r)}).call(this),define("stomp",function(){}),function(){function e(){}function i(e,t){var n=e.length;while(n--)if(e[n].listener===t)return n;return-1}function s(e){return function(){return this[e].apply(this,arguments)}}var t=e.prototype,n=this,r=n.EventEmitter;t.getListeners=function(t){var n=this._getEvents(),r,i;if(t instanceof RegExp){r={};for(i in n)n.hasOwnProperty(i)&&t.test(i)&&(r[i]=n[i])}else r=n[t]||(n[t]=[]);return r},t.flattenListeners=function(t){var n=[],r;for(r=0;r<t.length;r+=1)n.push(t[r].listener);return n},t.getListenersAsObject=function(t){var n=this.getListeners(t),r;return n instanceof Array&&(r={},r[t]=n),r||n},t.addListener=function(t,n){var r=this.getListenersAsObject(t),s=typeof n=="object",o;for(o in r)r.hasOwnProperty(o)&&i(r[o],n)===-1&&r[o].push(s?n:{listener:n,once:!1});return this},t.on=s("addListener"),t.addOnceListener=function(t,n){return this.addListener(t,{listener:n,once:!0})},t.once=s("addOnceListener"),t.defineEvent=function(t){return this.getListeners(t),this},t.defineEvents=function(t){for(var n=0;n<t.length;n+=1)this.defineEvent(t[n]);return this},t.removeListener=function(t,n){var r=this.getListenersAsObject(t),s,o;for(o in r)r.hasOwnProperty(o)&&(s=i(r[o],n),s!==-1&&r[o].splice(s,1));return this},t.off=s("removeListener"),t.addListeners=function(t,n){return this.manipulateListeners(!1,t,n)},t.removeListeners=function(t,n){return this.manipulateListeners(!0,t,n)},t.manipulateListeners=function(t,n,r){var i,s,o=t?this.removeListener:this.addListener,u=t?this.removeListeners:this.addListeners;if(typeof n!="object"||n instanceof RegExp){i=r.length;while(i--)o.call(this,n,r[i])}else for(i in n)n.hasOwnProperty(i)&&(s=n[i])&&(typeof s=="function"?o.call(this,i,s):u.call(this,i,s));return this},t.removeEvent=function(t){var n=typeof t,r=this._getEvents(),i;if(n==="string")delete r[t];else if(t instanceof RegExp)for(i in r)r.hasOwnProperty(i)&&t.test(i)&&delete r[i];else delete this._events;return this},t.removeAllListeners=s("removeEvent"),t.emitEvent=function(t,n){var r=this.getListenersAsObject(t),i,s,o,u;for(o in r)if(r.hasOwnProperty(o)){s=r[o].length;while(s--)i=r[o][s],i.once===!0&&this.removeListener(t,i.listener),u=i.listener.apply(this,n||[]),u===this._getOnceReturnValue()&&this.removeListener(t,i.listener)}return this},t.trigger=s("emitEvent"),t.emit=function(t){var n=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,n)},t.setOnceReturnValue=function(t){return this._onceReturnValue=t,this},t._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},t._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return n.EventEmitter=r,e},typeof define=="function"&&define.amd?define("EventEmitter",[],function(){return e}):typeof module=="object"&&module.exports?module.exports=e:this.EventEmitter=e}.call(this);var _info_kwarc_sally_comm_core_factory=function(){var e={name:"info_kwarc_sally_comm_core",defaultElementNamespaceURI:"http://kwarc.info/sally/comm/core",typeInfos:[{type:"classInfo",localName:"HeartbeatResponse",propertyInfos:[]},{type:"classInfo",localName:"HeartbeatRequest",propertyInfos:[]},{type:"classInfo",localName:"RegisterClientResponse",propertyInfos:[{type:"element",name:"sendQueue",elementName:"SendQueue",typeInfo:"String"}]},{type:"classInfo",localName:"RegisterClientRequest",propertyInfos:[{type:"element",name:"listenQueue",elementName:"ListenQueue",typeInfo:"String"},{type:"element",name:"schemas",collection:!0,elementName:"Schemas",typeInfo:"String"},{type:"element",name:"environmentID",elementName:"EnvironmentID",typeInfo:"String"}]}],elementInfos:[{elementName:"HeartbeatResponse",typeInfo:"info_kwarc_sally_comm_core.HeartbeatResponse"},{elementName:"HeartbeatRequest",typeInfo:"info_kwarc_sally_comm_core.HeartbeatRequest"},{elementName:"RegisterClientResponse",typeInfo:"info_kwarc_sally_comm_core.RegisterClientResponse"},{elementName:"RegisterClientRequest",typeInfo:"info_kwarc_sally_comm_core.RegisterClientRequest"}]};return{info_kwarc_sally_comm_core:e}};if(typeof define=="function"&&define.amd)define("info_kwarc_sally_comm_core",[],_info_kwarc_sally_comm_core_factory);else if(typeof module!="undefined"&&module.exports)module.exports.info_kwarc_sally_comm_core=_info_kwarc_sally_comm_core_factory().info_kwarc_sally_comm_core;else var info_kwarc_sally_comm_core=_info_kwarc_sally_comm_core_factory().info_kwarc_sally_comm_core;define("sally_client",["require","stomp","jsonix","EventEmitter","info_kwarc_sally_comm_core"],function(e){var t,n,r,i,s,o,u,a,f,l,c;return e("stomp"),n=e("jsonix").Jsonix,c=new RegExp('xmlns(:(\\w+))?="http://kwarc.info/sally/comm/([\\w/:.]+)"'),t=e("EventEmitter"),o=e("info_kwarc_sally_comm_core"),s=new n.Context([o.info_kwarc_sally_comm_core]),l=s.createUnmarshaller(),f=s.createMarshaller(),u=function(e,t,n){var r,i,s,o;r=[];for(s=0,o=n.length;s<o;s++)i=n[s],r.push(i.getName());return{name:{localPart:"RegisterClientRequest",namespaceURI:"http://kwarc.info/sally/comm/core"},value:{listenQueue:e,environmentID:t,schemas:r}}},a={name:{localPart:"HeartbeatResponse",namespaceURI:"http://kwarc.info/sally/comm/core"},value:{}},i={},r=function(){function e(e,t){this.config=e,this.msgHandler=t,i[e.stompUrl]!=null?this.stompClient=i[e.stompUrl]:(this.stompClient=Stomp.client(e.stompUrl),i[e.stompUrl]=this.stompClient,this.stompClient.connect(e.stompUser,e.stompPassword,function(e){return this.stompClient.connection_div.emit("onConnected")}.bind(this)))}return e.prototype.register=function(e,n,r){var i,s,o,h,p,d;this.schemas=e,s=this,i=this.stompClient;if(i.connected)return r();i.connection_div==null&&(i.connection_div=new t),o={};for(p=0,d=e.length;p<d;p++)h=e[p],o[h.getName()]=h;return i.connection_div.on("onConnected",function(t){return function(i){return t.privateQueue="editor_tools_"+Math.floor(Math.random()*1e5),t.stompClient.subscribe("/queue/"+t.privateQueue,function(e){var n,r,i;i=c.exec(e.body)[3],console.log(i,e.body);if(i!=="core")return r=o[i],n=r.unmarshal(e.body),r.handleMessage(n,function(n){return t.send(e.headers["reply-to"],r.marshal(n),null,{"correlation-id":e.headers["correlation-id"]})});n=l.unmarshalString(e.body),n.name.localPart==="HeartbeatRequest"&&t.send(e.headers["reply-to"],f.marshalString(a),null,{"correlation-id":e.headers["correlation-id"]})}),t.send("/queue/sally_register",f.marshalString(u(t.privateQueue,n,e)),function(t){var n,i,o,u;n=t.value.sendQueue,i=function(e){return e.send=function(t){return function(t,r,i){return s.send(n,e.marshal(t),r,i)}}(this)};for(o=0,u=e.length;o<u;o++)h=e[o],i(h);return r()})}}(this))},e.prototype.send=function(e,t,n,r){var i,s,o;return n!=null&&(i=Math.random(),s="/temp-queue/editor_exchange"+i,o=this.stompClient.subscribe(s,function(e){return function(t){var r;r=l.unmarshalString(t.body);if(n(r,t)===!0)return;return e.stompClient.unsubscribe(i)}}(this),{id:i}),r==null&&(r={}),r["reply-to"]=s,r["correlation-id"]=i),console.log("sending to ",e," msg ",t),this.stompClient.send(e,r,t.toString())},e}()});